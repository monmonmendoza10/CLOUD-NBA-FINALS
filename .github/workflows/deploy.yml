name: Deploy NBA Oracle to Azure Storage

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
      if: ${{ secrets.AZURE_CREDENTIALS }}
      continue-on-error: true
    
    - name: Check Azure Login Status
      id: login
      run: |
        if az account show > /dev/null 2>&1; then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "status=failed" >> $GITHUB_OUTPUT
        fi
    
    - name: Use Storage Account Name (Direct)
      id: storage
      run: |
        if [ -n "${{ secrets.STORAGE_ACCOUNT }}" ]; then
          echo "account=${{ secrets.STORAGE_ACCOUNT }}" >> $GITHUB_OUTPUT
        else
          # Try to get from first storage account in resource group
          ACCOUNT=$(az storage account list \
            --resource-group "${{ secrets.RESOURCE_GROUP }}" \
            --query "[0].name" -o tsv 2>/dev/null || echo "")
          if [ -z "$ACCOUNT" ]; then
            echo "‚ùå ERROR: Storage account not found!"
            echo "Please set STORAGE_ACCOUNT secret in GitHub"
            exit 1
          fi
          echo "account=$ACCOUNT" >> $GITHUB_OUTPUT
        fi
      if: steps.login.outputs.status == 'success'
    
    - name: Get Storage Account Key
      id: key
      run: |
        ACCOUNT=${{ steps.storage.outputs.account }}
        if [ -z "$ACCOUNT" ]; then
          echo "‚ùå ERROR: No storage account specified"
          exit 1
        fi
        
        if [ -n "${{ secrets.STORAGE_KEY }}" ]; then
          echo "key=${{ secrets.STORAGE_KEY }}" >> $GITHUB_OUTPUT
        else
          KEY=$(az storage account keys list \
            --resource-group "${{ secrets.RESOURCE_GROUP }}" \
            --account-name "$ACCOUNT" \
            --query "[0].value" -o tsv 2>/dev/null || echo "")
          
          if [ -z "$KEY" ]; then
            echo "‚ùå ERROR: Could not get storage key!"
            exit 1
          fi
          echo "::add-mask::$KEY"
          echo "key=$KEY" >> $GITHUB_OUTPUT
        fi
      if: steps.login.outputs.status == 'success'
    
    - name: Upload HTML Files
      run: |
        az storage blob upload-batch \
          --account-name "${{ steps.storage.outputs.account }}" \
          --account-key "${{ steps.key.outputs.key }}" \
          --destination '$web' \
          --source . \
          --pattern "*.html" \
          --overwrite
      if: steps.login.outputs.status == 'success'
    
    - name: Upload CSS Files
      run: |
        az storage blob upload-batch \
          --account-name "${{ steps.storage.outputs.account }}" \
          --account-key "${{ steps.key.outputs.key }}" \
          --destination '$web' \
          --source . \
          --pattern "*.css" \
          --overwrite
      if: steps.login.outputs.status == 'success'
    
    - name: Upload JavaScript Files
      run: |
        az storage blob upload-batch \
          --account-name "${{ steps.storage.outputs.account }}" \
          --account-key "${{ steps.key.outputs.key }}" \
          --destination '$web' \
          --source . \
          --pattern "*.js" \
          --overwrite
      if: steps.login.outputs.status == 'success'
    
    - name: Get Website URL
      id: website
      run: |
        ACCOUNT=${{ steps.storage.outputs.account }}
        URL="https://${ACCOUNT}.z5.web.core.windows.net/"
        echo "url=$URL" >> $GITHUB_OUTPUT
      if: steps.login.outputs.status == 'success'
    
    - name: Deployment Success
      run: |
        echo "‚úÖ Deployment Complete!"
        echo "üåê Website URL: ${{ steps.website.outputs.url }}"
      if: steps.login.outputs.status == 'success'
    
    - name: Deployment Failed - Missing Secrets
      run: |
        echo "‚ùå Deployment Failed!"
        echo ""
        echo "Missing or invalid GitHub Secrets. Please configure:"
        echo "1. AZURE_CREDENTIALS - Service Principal JSON"
        echo "2. STORAGE_ACCOUNT - Storage account name"
        echo "3. RESOURCE_GROUP - Azure resource group name"
        echo "4. STORAGE_KEY (optional) - Storage account key"
        echo ""
        echo "Instructions: docs/PHASE4-CICD-SETUP.md"
        exit 1
      if: steps.login.outputs.status != 'success'
    
    - name: Azure Logout
      run: az logout || true
